{{- $fullname := (printf "%s-%s" .Values.name .Values.environment) }}
{{- $githubFullname := printf "%s_%s" .Values.name .Values.environment | lower }}
{{- $namespace := (printf "%s-%s" .Values.club .Values.environment) }}
{{- $githubAppID := 1172114 }}
{{- $githubPrivateKey := "<path:avp/data/github/ci-infrastructure#app_private_key>" }}
{{- $githubToken := "<path:avp/data/github/ci-infrastructure#token>" }}
{{- $ecrRegistry := "786584124104.dkr.ecr.ap-northeast-2.amazonaws.com" }}
{{- $argoEventsHost := "argo-events.xquare.app" }}
{{- $gitopsRepo := "team-xquare/xquare-gitops-repo-v3" }}
{{- $webhookPort := 12000 }}
---
apiVersion: argoproj.io/v1alpha1
kind: EventBus
metadata:
  name: ci-eventbus
  namespace: {{ $namespace }}
spec:
  nats:
    native:
      replicas: 3 
      antiAffinity: false
      auth: none
      tolerations:
        - key: xquare/ci-server
          operator: Equal
          value: 'true'
          effect: NoSchedule
      containerTemplate:
        resources:
          requests:
            cpu: 30m
            memory: 64Mi
          limits:
            cpu: 250m
            memory: 128Mi
---
apiVersion: argoproj.io/v1alpha1
kind: EventSource
metadata:
  name: {{ $fullname }}-github-webhook
  namespace: {{ $namespace }}
spec:
  service:
    ports:
      - name: {{ $fullname }}
        port: {{ $webhookPort }}
        targetPort: {{ $webhookPort }}
  eventBusName: ci-eventbus
  template:
    tolerations:
      - key: xquare/ci-server
        operator: Equal
        value: 'true'
        effect: NoSchedule
    resources:
      requests:
        cpu: 30m
        memory: 64Mi
      limits:
        cpu: 200m
        memory: 128Mi
  github:
    {{ $githubFullname }}:
      repositories:
        - owner: {{ .Values.organization }}
          names:
            - {{ .Values.repository }}
      githubApp:
        privateKey:
          name: {{ $fullname }}-github-app-pem
          key: privateKey.pem
        appID: {{ $githubAppID }}
        installationID: {{ .Values.githubInstallationID }}
      webhook:
        endpoint: /webhooks/{{ $fullname }}
        port: "{{ $webhookPort }}"
        method: POST
        url: "https://{{ $argoEventsHost }}"
      events:
        - push
        - ping
      insecure: true
      active: true
      contentType: json
---
apiVersion: argoproj.io/v1alpha1
kind: Sensor
metadata:
  name: {{ $fullname }}-sensor
  namespace: {{ $namespace }}
spec:
  template:
    tolerations:
      - key: xquare/ci-server
        operator: Equal
        value: 'true'
        effect: NoSchedule
    serviceAccountName: {{ $fullname }}-workflow-sa
    resources:
      requests:
        cpu: 30m
        memory: 64Mi
      limits:
        cpu: 200m
        memory: 128Mi
  eventBusName: ci-eventbus
  dependencies:
    - name: {{ $fullname }}-github-push
      eventSourceName: {{ $fullname }}-github-webhook
      eventName: {{ $githubFullname }}
      filters:
        dataLogicalOperator: "or"
        data:
          - path: body.ref
            type: string
            value:
              - "refs/heads/{{ .Values.branch }}"
          - path: body.X-GitHub-Event
            type: string
            value:
              - "ping"
  triggers:
    - template:
        name: {{ $fullname }}-workflow-trigger
        k8s:
          operation: create
          source:
            resource:
              apiVersion: argoproj.io/v1alpha1
              kind: Workflow
              metadata:
                generateName: {{ $fullname }}-ci-
                namespace: {{ $namespace }}
              spec:
                serviceAccountName: {{ $fullname }}-workflow-sa
                entrypoint: ci-pipeline
                podGC:
                  strategy: OnPodCompletion
                podSpecPatch: |
                  tolerations:
                    - key: xquare/ci-server
                      operator: Equal
                      value: 'true'
                      effect: NoSchedule
                  containers:
                    - name: main
                      resources:
                        requests:
                          cpu: 100m
                          memory: 128Mi
                        limits:
                          cpu: 500m
                          memory: 512Mi
                arguments:
                  parameters:
                    - name: git-sha
                volumes:
                  - name: workspace
                    emptyDir: {}
                templates:
                  - name: ci-pipeline
                    dag:
                      tasks:
                        - name: build
                          template: docker-build
                          arguments:
                            parameters:
                              - name: sha
                                value: "{{`{{workflow.parameters.git-sha}}`}}"
                        - name: update-gitops
                          dependencies: [build]
                          template: update-gitops
                          arguments:
                            parameters:
                              - name: image-name
                                value: "{{ $ecrRegistry }}/{{ $namespace }}/{{ .Values.name }}:{{`{{workflow.parameters.git-sha}}`}}"

                  - name: docker-build
                    tolerations:
                      - key: xquare/ci-server
                        operator: Equal
                        value: 'true'
                        effect: NoSchedule
                    inputs:
                      parameters:
                        - name: sha
                    initContainers:
                      - name: checkout-and-prepare
                        image: python:3.9-alpine
                        command: ["/bin/sh", "-c"]
                        args:
                          - |
                            apk add --no-cache git jq curl
                            pip install jinja2-cli

                            SHA="{{`{{inputs.parameters.sha}}`}}"
                            git clone -b {{ .Values.branch }} --single-branch https://github.com/{{ .Values.organization }}/{{ .Values.repository }}.git /workspace/repo
                            cd /workspace/repo
                            
                            if [ "$SHA" != "latest" ]; then
                              git checkout $SHA
                            fi

                            echo '{{ .Values.buildConfig }}' > /tmp/config.json
                            BUILDER=$(jq -r '.builder // "default"' /tmp/config.json)

                            curl -s "https://raw.githubusercontent.com/team-xquare/gitops-repo-v3/main/templates/dockerfile/templates/${BUILDER}.template" -o /tmp/template.j2 || echo "FROM alpine:latest" > /tmp/template.j2
                            jinja2 /tmp/template.j2 /tmp/config.json > /workspace/repo/Dockerfile
                        resources:
                          requests:
                            cpu: 100m
                            memory: 128Mi
                          limits:
                            cpu: 300m
                            memory: 256Mi
                        volumeMounts:
                          - name: workspace
                            mountPath: /workspace
                    container:
                      image: gcr.io/kaniko-project/executor:latest
                      args:
                        - "--context=/workspace/repo"
                        - "--dockerfile=/workspace/repo/Dockerfile"
                        - "--destination={{ $ecrRegistry }}/{{ $namespace }}/{{ .Values.name }}:{{`{{inputs.parameters.sha}}`}}"
                        - "--destination={{ $ecrRegistry }}/{{ $namespace }}/{{ .Values.name }}:latest"
                        - "--cache=true"
                        - "--cache-repo={{ $ecrRegistry }}/cache"
                      resources:
                        requests:
                          cpu: 250m
                          memory: 512Mi
                        limits:
                          cpu: 1000m
                          memory: 1Gi
                      env:
                        - name: AWS_SDK_LOAD_CONFIG
                          value: "true"
                      volumeMounts:
                        - name: workspace
                          mountPath: /workspace

                  - name: update-gitops
                    tolerations:
                      - key: xquare/ci-server
                        operator: Equal
                        value: 'true'
                        effect: NoSchedule
                    inputs:
                      parameters:
                        - name: image-name
                    container:
                      image: bitnami/git:latest
                      command: [sh, -c]
                      args:
                        - |
                          curl -X POST \
                            -H "Authorization: token ${GITHUB_TOKEN}" \
                            -H "Accept: application/vnd.github.v3+json" \
                            https://api.github.com/repos/{{ $gitopsRepo }}/dispatches \
                            -d '{
                              "event_type": "config-api",
                              "client_payload": {
                                "path": "{{ .Values.club }}/{{ .Values.name }}/{{ .Values.environment }}",
                                "action": "apply",
                                "spec": {
                                  "image_name": "'"{{`{{inputs.parameters.image-name}}`}}"'"
                                }
                              }
                            }'
                      resources:
                        requests:
                          cpu: 50m
                          memory: 64Mi
                        limits:
                          cpu: 100m
                          memory: 128Mi
                      env:
                        - name: GITHUB_TOKEN
                          valueFrom:
                            secretKeyRef:
                              name: {{ $fullname }}-github-token
                              key: token
          parameters:
            - src:
                dependencyName: {{ $fullname }}-github-push
                dataKey: body.after
              dest: spec.arguments.parameters.0.value
              when: "{{ `{{ has .Input.body \"after\" }}` }}"
      retryStrategy:
        steps: 3
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: {{ $fullname }}-github-webhook-vs
  namespace: {{ $namespace }}
  annotations:
    external-dns.alpha.kubernetes.io/hostname: {{ $argoEventsHost }}
spec:
  hosts:
    - "{{ $argoEventsHost }}"
  gateways:
    - istio-system/xquare-ingressgateway
  http:
    - match:
        - uri:
            prefix: /webhooks/{{ $fullname }}
      route:
        - destination:
            host: {{ $fullname }}-github-webhook-eventsource-svc
            port:
              number: {{ $webhookPort }}
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: {{ $fullname }}-workflow-sa
  namespace: {{ $namespace }}
  annotations:
    eks.amazonaws.com/role-arn: "arn:aws:iam::786584124104:role/kaniko-ecr-push-role"
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: {{ $fullname }}-workflow-role
  namespace: {{ $namespace }}
rules:
  - apiGroups: [""]
    resources: ["pods", "pods/log"]
    verbs: ["get", "watch", "patch"]
  - apiGroups: [""]
    resources: ["secrets"]
    verbs: ["get"]
  - apiGroups: ["argoproj.io"]
    resources: ["workflows", "workflows/finalizers"]
    verbs: ["get", "list", "watch", "update", "patch", "create"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: {{ $fullname }}-workflow-rolebinding
  namespace: {{ $namespace }}
subjects:
  - kind: ServiceAccount
    name: {{ $fullname }}-workflow-sa
roleRef:
  kind: Role
  name: {{ $fullname }}-workflow-role
  apiGroup: rbac.authorization.k8s.io
---
apiVersion: v1
kind: Secret
metadata:
  name: {{ $fullname }}-github-app-pem
  namespace: {{ $namespace }}
type: Opaque
data:
  privateKey.pem: "{{ $githubPrivateKey | b64enc }}"
---
apiVersion: v1
kind: Secret
metadata:
  name: {{ $fullname }}-github-token
  namespace: {{ $namespace }}
type: Opaque
data:
  token: "{{ $githubToken | b64enc }}"
