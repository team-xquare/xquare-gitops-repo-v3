{{- $fullname := (printf "%s-%s" .Values.name .Values.environment) }}
{{- $githubFullname := printf "%s_%s" .Values.name .Values.environment | replace "-" "_" | lower }}
{{- $namespace := (printf "%s-%s" .Values.club .Values.environment) }}
{{- $githubAppID := 1172114 }}
{{- $githubInstallationID := .Values.githubInstallationID | int }}
{{- $githubPrivateKey := "<path:avp/data/github/ci-infrastructure#app_private_key>" }}
{{- $githubToken := "<path:avp/data/github/ci-infrastructure#token>" }}
{{- $ecrRegistry := "786584124104.dkr.ecr.ap-northeast-2.amazonaws.com" }}
{{- $argoEventsHost := "argo-events.xquare.app" }}
{{- $gitopsRepo := "team-xquare/xquare-gitops-repo-v3" }}
{{- $webhookPort := 12000 }}
{{- $useLatestTag := empty .Values.imageTag }}
---
apiVersion: argoproj.io/v1alpha1
kind: EventBus
metadata:
  name: ci-eventbus
  namespace: {{ $namespace }}
spec:
  nats:
    native:
      replicas: 3
      antiAffinity: false
      auth: none
      tolerations:
        - key: xquare/ci-server
          operator: Equal
          value: 'true'
          effect: NoSchedule
      containerTemplate:
        resources:
          requests:
            cpu: 15m
            memory: 25Mi
          limits:
            cpu: 40m
            memory: 50Mi
---
apiVersion: argoproj.io/v1alpha1
kind: EventSource
metadata:
  name: {{ $fullname }}-github-webhook
  namespace: {{ $namespace }}
  annotations:
    sidecar.istio.io/inject: "false"
spec:
  eventBusName: ci-eventbus
  github:
    {{ $githubFullname }}:
      repositories:
        - owner: {{ .Values.organization }}
          names:
            - {{ .Values.repository }}
      githubApp:
        privateKey:
          name: {{ $fullname }}-github-app-pem
          key: privateKey.pem
        appID: {{ $githubAppID }}
        installationID: {{ $githubInstallationID }}
      webhook:
        endpoint: /webhooks/{{ $fullname }}
        port: "{{ $webhookPort }}"
        method: POST
        url: "https://{{ $argoEventsHost }}"
      events:
        - push
      insecure: true
      active: true
      contentType: json
  service:
    ports:
      - name: {{ $fullname }}
        port: {{ $webhookPort }}
        targetPort: {{ $webhookPort }}
  template:
    container:
      resources:
        requests:
          cpu: 25m
          memory: 40Mi
        limits:
          cpu: 60m
          memory: 75Mi
    tolerations:
      - key: xquare/ci-server
        operator: Equal
        value: 'true'
        effect: NoSchedule
---
apiVersion: argoproj.io/v1alpha1
kind: Sensor
metadata:
  name: {{ $fullname }}-sensor
  namespace: {{ $namespace }}
  annotations:
    sidecar.istio.io/inject: "false"
spec:
  dependencies:
    - name: {{ $fullname }}-github-push
      eventName: {{ $githubFullname }}
      eventSourceName: {{ $fullname }}-github-webhook
      filters:
        data:
          - path: body.ref
            type: string
            value:
              - "refs/heads/{{ .Values.branch }}"
          {{- if $useLatestTag }}
          - path: body.X-GitHub-Event
            type: string
            value:
              - "ping"
          {{- end }}
        dataLogicalOperator: "or"
  eventBusName: ci-eventbus
  template:
    container:
      resources:
        requests:
          cpu: 25m
          memory: 40Mi
        limits:
          cpu: 60m
          memory: 75Mi
    serviceAccountName: kaniko-sa
    tolerations:
      - key: xquare/ci-server
        operator: Equal
        value: 'true'
        effect: NoSchedule
  triggers:
    - retryStrategy:
        steps: 3
      template:
        k8s:
          operation: create
          {{- if not $useLatestTag }}
          parameters:
            - src:
                dependencyName: {{ $fullname }}-github-push
                dataKey: body.after
              dest: spec.arguments.parameters.0.value
          {{- end }}
          source:
            resource:
              apiVersion: argoproj.io/v1alpha1
              kind: Workflow
              metadata:
                generateName: {{ $fullname }}-ci-
                namespace: {{ $namespace }}
                annotations:
                  sidecar.istio.io/inject: "false"
              spec:
                {{- if not $useLatestTag }}
                arguments:
                  parameters:
                    - name: git-sha
                {{- end }}
                entrypoint: ci-pipeline
                # podGC:
                #   strategy: OnPodCompletion
                serviceAccountName: kaniko-sa
                templates:
                  - name: ci-pipeline
                    dag:
                      tasks:
                        - name: build
                          {{- if not $useLatestTag }}
                          arguments:
                            parameters:
                              - name: sha
                                value: "{{`{{workflow.parameters.git-sha}}`}}"
                          {{- end }}
                          template: docker-build
                        - name: update-gitops
                          arguments:
                            parameters:
                              - name: image-tag
                                {{- if $useLatestTag }}
                                value: "latest"
                                {{- else }}
                                value: "{{`{{workflow.parameters.git-sha}}`}}"
                                {{- end }}
                          dependencies: [build]
                          template: update-gitops

                  - name: docker-build
                    metadata:
                      annotations:
                        sidecar.istio.io/inject: "false"
                    tolerations:
                      - key: xquare/ci-server
                        operator: Equal
                        value: 'true'
                        effect: NoSchedule
                    {{- if not $useLatestTag }}
                    inputs:
                      parameters:
                        - name: sha
                    {{- end }}
                    container:
                      image: gcr.io/kaniko-project/executor:latest
                      args:
                        - "--context=/workspace/repo"
                        - "--dockerfile=/workspace/repo/Dockerfile"
                        {{- if not $useLatestTag }}
                        - "--destination={{ $ecrRegistry }}/{{ $namespace }}/{{ .Values.name }}:{{`{{inputs.parameters.sha}}`}}"
                        {{- end }}
                        - "--destination={{ $ecrRegistry }}/{{ $namespace }}/{{ .Values.name }}:latest"
                        - "--cache=true"
                        - "--cache-repo={{ $ecrRegistry }}/cache"
                      env:
                        - name: AWS_SDK_LOAD_CONFIG
                          value: "true"
                      resources:
                        requests:
                          cpu: 1
                          memory: 7Gi
                        limits:
                          cpu: 2
                          memory: 8Gi
                      volumeMounts:
                        - name: workspace
                          mountPath: /workspace
                    initContainers:
                      - name: checkout-and-prepare
                        image: alpine:3.18
                        command: ["/bin/sh", "-c"]
                        args:
                          - |
                            set -e

                            echo "--- Starting script execution ---"
                            echo "Installing required packages..."
                            apk add --no-cache git jq curl openssl py3-jinja2

                            APP_ID={{ $githubAppID }}
                            INSTALL_ID={{ $githubInstallationID }}

                            echo "install_id: {{ $githubInstallationID }}"
                            echo "APP_ID: $APP_ID"
                            echo "INSTALL_ID: $INSTALL_ID"

                            echo "Setting up private key..."
                            echo "$GITHUB_PRIVATE_KEY" > /tmp/key.pem
                            chmod 600 /tmp/key.pem
                            ls -la /tmp/key.pem

                            echo "Calculating JWT timestamps..."
                            now=$(date +%s)
                            iat=$((now-60))
                            exp=$((now+600))
                            echo "Current time: $now, iat: $iat, exp: $exp"

                            b64enc() { 
                              openssl base64 | tr -d '=' | tr '/+' '_-' | tr -d '\n'
                            }

                            echo "Creating JWT header..."
                            header_json='{
                                "typ":"JWT",
                                "alg":"RS256"
                            }'
                            header=$(echo -n "${header_json}" | b64enc)
                            echo "Header (encoded): $header"

                            echo "Creating JWT payload..."
                            payload_json="{
                                \"iat\":${iat},
                                \"exp\":${exp},
                                \"iss\":${APP_ID}
                            }"
                            echo "Raw payload: $payload_json"
                            payload=$(echo -n "${payload_json}" | b64enc)
                            echo "Payload (encoded): $payload"

                            echo "Creating JWT signature..."
                            header_payload="${header}.${payload}"
                            echo "Header.Payload: $header_payload"

                            # Attempt to create signature with debug info
                            echo "Testing openssl command functionality..."
                            echo -n "test" | openssl dgst -sha256 && echo "OpenSSL basic test passed" || echo "OpenSSL basic test FAILED"

                            echo "Generating JWT signature..."
                            signature_output=$(openssl dgst -sha256 -sign /tmp/key.pem <(echo -n "${header_payload}") 2>&1)
                            signature_status=$?
                            if [ $signature_status -ne 0 ]; then
                              echo "ERROR: Failed to generate signature: $signature_output"
                              exit 1
                            else
                              echo "Signature generation command executed successfully"
                            fi

                            signature=$(openssl dgst -sha256 -sign /tmp/key.pem <(echo -n "${header_payload}") | b64enc)
                            echo "Signature (encoded): ${signature:0:20}..." # Show just the beginning for security

                            echo "Assembling full JWT token..."
                            JWT="${header_payload}.${signature}"
                            echo "JWT token (first 40 chars): ${JWT:0:40}..."

                            echo "Making GitHub API request..."
                            curl_response=$(curl -v -X POST \
                              -H "Authorization: Bearer ${JWT}" \
                              -H "Accept: application/vnd.github+json" \
                              "https://api.github.com/app/installations/${INSTALL_ID}/access_tokens" 2>&1)
                            echo "Curl response: $curl_response"

                            TOKEN=$(echo "$curl_response" | grep -A20 "< HTTP" | jq -r '.token' 2>/dev/null)
                            echo "Extracted token (first 10 chars or 'null'): ${TOKEN:0:10}..."

                            if [ -z "$TOKEN" ] || [ "$TOKEN" = "null" ]; then
                              echo "ERROR: Failed to get GitHub token, API response:"
                              echo "$curl_response" | grep -A50 "< HTTP"
                              exit 1
                            else
                              echo "Successfully obtained GitHub token"
                            fi

                            echo "Token: $TOKEN"

                            echo "Cloning repository..."
                            git_clone_output=$(git clone -b {{ .Values.branch }} --single-branch \
                              https://x-access-token:${TOKEN}@github.com/{{ .Values.organization }}/{{ .Values.repository }}.git \
                              /workspace/repo 2>&1)
                            git_clone_status=$?
                            echo "Git clone output: $git_clone_output"
                            if [ $git_clone_status -ne 0 ]; then
                              echo "ERROR: Git clone failed with status $git_clone_status"
                              exit 1
                            fi

                            echo "Changing to repository directory..."
                            cd /workspace/repo || { echo "ERROR: Could not change to repository directory"; exit 1; }

                            {{- if not $useLatestTag }}
                            echo "Checking out specific commit..."
                            git_checkout_output=$(git checkout "{{`{{inputs.parameters.sha}}`}}" 2>&1)
                            git_checkout_status=$?
                            echo "Git checkout output: $git_checkout_output"
                            if [ $git_checkout_status -ne 0 ]; then
                              echo "ERROR: Git checkout failed with status $git_checkout_status"
                              exit 1
                            fi
                            {{- end }}

                            echo "Creating build config file..."
                            echo '{{ .Values.buildConfig }}' > /tmp/config.json
                            echo "Build config content:"
                            cat /tmp/config.json

                            echo "Determining builder type..."
                            BUILDER=$(jq -r '.builder // "default"' /tmp/config.json)
                            echo "Builder: $BUILDER"

                            echo "Fetching Dockerfile template..."
                            curl_template_output=$(curl -s "https://raw.githubusercontent.com/team-xquare/xquare-gitops-repo-v3/refs/heads/main/templates/dockerfile/templates/${BUILDER}.template" -o /tmp/template.j2 2>&1)
                            curl_template_status=$?
                            if [ $curl_template_status -ne 0 ]; then
                              echo "WARNING: Failed to fetch template, using default. Error: $curl_template_output"
                              echo "FROM alpine:latest" > /tmp/template.j2
                            else
                              echo "Successfully fetched template"
                            fi
                            echo "Template content:"
                            cat /tmp/template.j2

                            echo "Rendering Dockerfile..."
                            python_output=$(python3 -c "import jinja2; import json; print(jinja2.Template(open('/tmp/template.j2').read()).render(**json.load(open('/tmp/config.json'))))" 2>&1)
                            python_status=$?
                            if [ $python_status -ne 0 ]; then
                              echo "ERROR: Python rendering failed: $python_output"
                              exit 1
                            else
                              python3 -c "import jinja2; import json; print(jinja2.Template(open('/tmp/template.j2').read()).render(**json.load(open('/tmp/config.json'))))" > /workspace/repo/Dockerfile
                              echo "Successfully rendered Dockerfile:"
                              cat /workspace/repo/Dockerfile
                            fi

                            echo "--- Script execution completed ---"
                        env:
                          - name: GITHUB_PRIVATE_KEY
                            valueFrom:
                              secretKeyRef:
                                name: {{ $fullname }}-github-app-pem
                                key: privateKey.pem
                        resources:
                          requests:
                            cpu: 40m
                            memory: 64Mi
                          limits:
                            cpu: 100m
                            memory: 128Mi
                        volumeMounts:
                          - name: workspace
                            mountPath: /workspace

                  - name: update-gitops
                    metadata:
                      annotations:
                        sidecar.istio.io/inject: "false"
                    tolerations:
                      - key: xquare/ci-server
                        operator: Equal
                        value: 'true'
                        effect: NoSchedule
                    inputs:
                      parameters:
                        - name: image-tag
                    container:
                      image: curlimages/curl:latest
                      command: ["/bin/sh", "-c"]
                      args:
                        - |
                          curl -X POST \
                            -H "Authorization: token ${GITHUB_TOKEN}" \
                            -H "Accept: application/vnd.github.v3+json" \
                            https://api.github.com/repos/{{ $gitopsRepo }}/dispatches \
                            -d '{
                              "event_type": "config-api",
                              "client_payload": {
                                "path": "{{ .Values.club }}/{{ .Values.name }}/{{ .Values.environment }}",
                                "action": "apply",
                                "spec": {
                                  "imageTag": "'"{{`{{inputs.parameters.image-tag}}`}}"'"
                                }
                              }
                            }'
                      env:
                        - name: GITHUB_TOKEN
                          valueFrom:
                            secretKeyRef:
                              key: token
                              name: {{ $fullname }}-github-token
                      resources:
                        requests:
                          cpu: 15m
                          memory: 25Mi
                        limits:
                          cpu: 40m
                          memory: 50Mi
                volumes:
                  - name: workspace
                    emptyDir: {}
        name: {{ $fullname }}-workflow-trigger
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: {{ $fullname }}-github-webhook-vs
  namespace: {{ $namespace }}
  annotations:
    external-dns.alpha.kubernetes.io/hostname: {{ $argoEventsHost }}
spec:
  hosts:
    - "{{ $argoEventsHost }}"
  gateways:
    - istio-system/xquare-ingressgateway
  http:
    - match:
        - uri:
            prefix: /webhooks/{{ $fullname }}
      route:
        - destination:
            host: {{ $fullname }}-github-webhook-eventsource-svc
            port:
              number: {{ $webhookPort }}
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: kaniko-sa
  namespace: {{ $namespace }}
  annotations:
    eks.amazonaws.com/role-arn: "arn:aws:iam::786584124104:role/kaniko-ecr-push-role"
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: {{ $fullname }}-workflow-role
  namespace: {{ $namespace }}
rules:
  - apiGroups: [""]
    resources: ["pods", "pods/log"]
    verbs: ["get", "watch", "patch", "list", "delete"]
  - apiGroups: [""]
    resources: ["secrets"]
    verbs: ["get"]
  - apiGroups: [""]
    resources: ["configmaps", "persistentvolumeclaims"]
    verbs: ["get", "list", "watch", "create", "update", "delete", "patch"]
  - apiGroups: [""]
    resources: ["events"]
    verbs: ["create", "patch", "list"]
  - apiGroups: ["argoproj.io"]
    resources: ["workflows", "workflows/finalizers", "workflowtaskresults"]
    verbs: ["get", "list", "watch", "update", "patch", "create", "delete"]
  - apiGroups: ["policy"]
    resources: ["poddisruptionbudgets"]
    verbs: ["create", "get", "delete"]
  - apiGroups: ["coordination.k8s.io"]
    resources: ["leases"]
    verbs: ["get", "create", "update", "list"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: {{ $fullname }}-workflow-rolebinding
  namespace: {{ $namespace }}
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: {{ $fullname }}-workflow-role
subjects:
  - kind: ServiceAccount
    name: kaniko-sa
---
apiVersion: v1
kind: Secret
metadata:
  name: {{ $fullname }}-github-app-pem
  namespace: {{ $namespace }}
type: Opaque
data:
  privateKey.pem: "{{ $githubPrivateKey | b64enc }}"
---
apiVersion: v1
kind: Secret
metadata:
  name: {{ $fullname }}-github-token
  namespace: {{ $namespace }}
type: Opaque
data:
  token: "{{ $githubToken | b64enc }}"